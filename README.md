# Скрипт проверки наличия текста на веб-страницах

## Описание

Этот скрипт предназначен для автоматической проверки наличия текстовых строк на веб-страницах. 

Поддерживает два режима работы:
1. **Excel режим**: Массовая проверка строк из столбца G на страницах по ссылкам из столбца I
2. **Прямой режим**: Проверка конкретного текста на указанном URL

## Возможности

- ✅ **Два режима работы**: Excel файл или прямая проверка URL
- ✅ Чтение данных из Excel файла (с поддержкой нескольких листов)
- ✅ Выполнение HTTP запросов к веб-страницам
- ✅ Парсинг HTML контента
- ✅ Двухуровневый поиск текста (точное и нечеткое совпадение)
- ✅ Экспорт найденных совпадений в CSV
- ✅ Детальное логирование результатов
- ✅ Обработка ошибок (таймауты, недоступные страницы и т.д.)
- ✅ Задержки между запросами для предотвращения блокировки
- ✅ Статистика по завершению обработки

## Установка

### 1. Установите Python

Убедитесь, что у вас установлен Python 3.8 или выше.

### 2. Установите зависимости

```bash
pip install -r requirements.txt
```

Или установите вручную:

```bash
pip install pandas openpyxl requests beautifulsoup4 lxml
```

## Использование

### Режим 1: Проверка из Excel файла

Базовый запуск:
```bash
python check_links.py <путь_к_файлу.xlsx>
```

Примеры:
```bash
# Основной запуск (CSV: example_found_matches.csv, логи: logs/)
python check_links.py example.xlsx

# Кастомная папка для логов
python check_links.py example.xlsx --log-dir my_logs

# Обработка всех листов
python check_links.py example.xlsx --all-sheets

# Обработка конкретных листов по индексам (начиная с 0)
python check_links.py example.xlsx --sheets 0 1

# Обработка конкретных листов по именам
python check_links.py example.xlsx --sheets "Лист1" "Результаты"

# С увеличенной задержкой между запросами (2 секунды)
python check_links.py example.xlsx --delay 2

# С кастомным таймаутом (15 секунд)
python check_links.py example.xlsx --timeout 15

# Сохранение найденных совпадений в CSV
python check_links.py example.xlsx --output-csv found_matches.csv

# Комбинация параметров с автоматическим CSV
python check_links.py example.xlsx --all-sheets --delay 0.5 --timeout 20

# Полный пример с кастомными путями
python check_links.py example.xlsx --log-dir ./run_logs --output-csv results.csv --all-sheets
```

### Режим 2: Прямая проверка URL

Проверка конкретного текста на указанной странице:

```bash
# Базовая проверка
python check_links.py --url https://example.com/page --text "Текст для поиска"

# С сохранением результата в CSV
python check_links.py --url https://example.com --text "Important text" --output-csv result.csv

# С кастомной папкой для логов
python check_links.py --url https://example.com --text "Search query" --log-dir ./my_logs

# Проверка локального файла
python check_links.py --url C:/path/to/file.html --text "Local content"

# Многострочный текст (в кавычках)
python check_links.py --url https://example.com --text "Первая строка
Вторая строка
Третья строка"
```

### Аргументы командной строки

#### Общие аргументы (для обоих режимов):
- **`-d, --delay`** - Задержка между запросами в секундах (по умолчанию: 1.0)
- **`-t, --timeout`** - Таймаут для HTTP запросов в секундах (по умолчанию: 10)
- **`-o, --output-csv [FILE]`** - CSV файл для сохранения найденных совпадений (автогенерация для Excel режима)
- **`-l, --log-dir DIR`** - Папка для логов (по умолчанию: logs/)
- **`-h, --help`** - Показать справку

#### Режим Excel:
- **`excel_file`** - Путь к Excel файлу для обработки
- **`--all-sheets`** - Обработать все листы в Excel файле (по умолчанию: только первый)
- **`--sheets SHEET [SHEET ...]`** - Указать конкретные листы по именам или индексам

#### Режим прямого URL:
- **`--url URL`** - URL для проверки (веб-адрес или локальный файл)
- **`--text TEXT`** - Текст для поиска на странице (обязателен с --url)

### Работа с листами Excel

По умолчанию скрипт обрабатывает только первый лист Excel файла. Вы можете изменить это поведение:

- **Один лист** (по умолчанию): Обрабатывается только первый лист
- **Все листы**: Используйте `--all-sheets` для обработки всех листов
- **Конкретные листы**: Используйте `--sheets` с указанием имен или индексов листов

**Примеры:**
```bash
# Только первый лист (по умолчанию)
python check_links.py data.xlsx

# Все листы
python check_links.py data.xlsx --all-sheets

# Конкретные листы по индексам (начиная с 0)
python check_links.py data.xlsx --sheets 0 2 4

# Конкретные листы по именам
python check_links.py data.xlsx --sheets "Лист1" "Результаты"
```

### Поиск текста

Скрипт использует **двухуровневый поиск текста**:

#### 1. Точное совпадение (✓)
Сначала ищется точное совпадение искомого текста на странице.

#### 2. Гибкий поиск (≈)
Если точное совпадение не найдено, выполняется **двухуровневый гибкий поиск**:

**Уровень 1: Очистка без удаления цифр**
- Удаляются конструкции `[id123|Текст]` → оставляется только `Текст`
- Удаляются знаки препинания и специальные символы
- Ищется полное совпадение очищенного текста
- Если не найдено, ищется последовательность слов в правильном порядке (с допуском до 1 лишнего слова между искомыми)

**Уровень 2: Очистка с удалением цифр** (если уровень 1 не нашел)
- Удаляются все цифры и буквы, "прилипшие" к цифрам (например, `id123` → удаляется полностью)
- Повторяется поиск полного совпадения и последовательности слов

**Важно:** Проверяется **порядок слов** - слова должны идти в той же последовательности, что и в поисковом тексте

**Примеры:**
```
✓ FOUND (exact match) - Текст найден точно
≈ FOUND (fuzzy match) - Текст найден через гибкий поиск
✗ NOT FOUND - Текст не найден
```

### Формат входных данных

Структура Excel файла:
- **Столбец G**: Текстовые строки для поиска
- **Столбец I**: Ссылки на веб-страницы

### Просмотр справки

```bash
python check_links.py --help
```

### Выходные данные

Скрипт создает лог-файл с именем формата:
```
check_results_YYYYMMDD_HHMMSS.log
```

В логе для каждой строки указывается:
- Номер строки
- Текст для поиска
- Ссылка
- Результат проверки (найдено/не найдено/ошибка)

### CSV вывод найденных совпадений

Если указан параметр `--output-csv`, скрипт сохранит все найденные совпадения в CSV файл с двумя колонками:

- **URL**: Ссылка на веб-страницу
- **Found Text**: Найденный текст (может содержать несколько строк)

CSV файл использует правильное экранирование для многострочного текста. Пример содержимого:

```csv
URL,Found Text
"https://example.com/page1","This is found text with
multiple lines and special characters"
"https://example.com/page2","Simple text"
```

Файл сохраняется с кодировкой UTF-8 с BOM для корректного отображения в Excel.

## Примеры вывода

### Успешное нахождение текста
```
2025-11-12 10:15:23 - INFO - Строка 5: ✓ НАЙДЕНО - Текст присутствует на странице
```

### Текст не найден
```
2025-11-12 10:15:25 - WARNING - Строка 7: ✗ НЕ НАЙДЕНО - Текст отсутствует на странице
```

### Ошибка при обработке
```
2025-11-12 10:15:27 - ERROR - Строка 10: ОШИБКА - Таймаут при обращении к https://example.com
```

### Итоговая статистика
```
================================================================================
ИТОГОВАЯ СТАТИСТИКА:
Всего обработано строк: 100
Текст найден: 75
Текст не найден: 20
Ошибки при обработке: 5
================================================================================
```

## Настройки

В скрипте можно изменить следующие параметры:

- **delay** (по умолчанию 1 секунда): Задержка между запросами
- **timeout** (по умолчанию 10 секунд): Таймаут для HTTP запросов
- **HEADERS**: Заголовки HTTP запросов

## Обработка ошибок

Скрипт обрабатывает следующие типы ошибок:
- Таймауты соединения
- Ошибки HTTP (404, 403, 500 и т.д.)
- Недоступные серверы
- Невалидные URL
- Пустые значения в столбцах

## Рекомендации

1. **Задержка между запросами**: Не уменьшайте значение delay ниже 1 секунды, чтобы избежать блокировки
2. **Большие файлы**: Для файлов с большим количеством строк рекомендуется запускать скрипт в фоновом режиме
3. **Проксирование**: Для большого количества запросов рекомендуется использовать прокси-серверы

## Лицензия

MIT

## Автор

Created with AI assistance

